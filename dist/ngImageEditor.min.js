/*! ng-image-editor 0.2.2 | Copyright (c) 2016 sparrow.jang | MIT license */
!function(a){"use strict";var b=a.module("ngImageEditor",[]),c=function(a){this.canvas_=a,this.ctx_=a.getContext("2d")};a.extend(c.prototype,{refresh:function(){var a=this.canvas_,b=a.parentNode;a.width=b.clientWidth,a.height=b.clientHeight},converterToGray_:function(){var a,b,c,d=this.ctx_,e=this.canvas_;if(0!=e.width&&0!=e.height){a=d.getImageData(0,0,e.width,e.height),b=a.data,c=b.length;for(var f=0;c>f;f+=4){var g=(b[f],b[f+1],b[f+2],.34*b[f]+.5*b[f+1]+.16*b[f+2]);b[f]=g,b[f+1]=g,b[f+2]=g}d.putImageData(a,0,0)}},drawImageBlock:function(a,b,c,d,e,f,g,h,i){var j=h/a.width,k=i/a.height,l=d/a.width*f,m=e/a.height*g,n=f*j,o=g*k;b.drawImage(c,l,m,n,o,d,e,h,i)},render:function(a,b,c){if(c){var d=this.ctx_,e=this.canvas_,f=e.width,g=e.height;c.width/f,c.height/g;d.drawImage(a,0,0,f,g),this.converterToGray_(),this.drawImageBlock(e,d,a,b.left,b.top,c.width,c.height,b.width,b.height)}},refreshAndRender:function(a,b,c){this.refresh(),this.render(a,b,c)},toDataURL:function(a,b){var c=this.canvas_,d=document.createElement("canvas"),e=d.getContext("2d");if(b.useOriginalImg){var f=b.img,g=b.imgSize,h=c.width/g.width,i=c.height/g.height,j=a.width/h,k=a.height/i,l=a.left/h,m=a.top/i,n=a.width/h,o=a.height/i;d.width=j,d.height=k,e.drawImage(f,l,m,n,o,0,0,j,k)}else d.width=a.width,d.height=a.height,e.drawImage(c,a.left,a.top,a.width,a.height,0,0,a.width,a.height);return d.toDataURL(b.imageType)}}),b.directive("ngImageEditor",["$q","$document",function(b,d){var e=function(c){var d=new Image,e=document.createElement("div"),f=b.defer(),g=a.element(document.body);return d.crossOrigin="Anonymous",e.style.cssText="width:0px;height:0px;overflow:hidden;",d.onload=function(){var a,b;a=d.width,b=d.height,e.parentNode.removeChild(e),f.resolve({width:a,height:b})},e.appendChild(d),d.src=a.isString(c)?c:c.src,g.append(e),f.promise};return{scope:{imgSrc:"=",ngImageEditor:"=?",onImgChange:"&",enabledResizeSelector:"=?",selected:"=",aspectRatio:"@?"},template:'<div ng-mouseup="cancel( $event )" unselectable="on"><img unselectable="on" style="opacity:0;user-drag: none;width:100%;height:100%;" crossorigin="Anonymous" ng-src="{{imgSrc}}" ng-mousedown="$event.preventDefault()" /><canvas width="100%" height="100%" style="position:absolute;top:0px;left:0px;"></canvas><div ng-image-selected></div></div>',controller:["$scope","$element","$attrs",function(b,f,g){var h,i,j,k,l,m;f.css({position:"relative","user-drag":"none"}).attr("unselectable","on"),i=f.find("canvas"),h=i[0],j=new c(h),k=f.find("img")[0],m=a.element(document.body);var n={imgSrc:function(a){var c=e(a);c.then(function(a){l=a,j.refreshAndRender(k,b.selected,l),b.onImgChange({imgSize:l})})},selected:function(a){null==b.dragEvent&&l&&j.refreshAndRender(k,a,l)},aspectRatio:function(){var a=b.selected;b.resizeSelected(a.top,a.left,a.width,a.height)}};b.$watch("imgSrc",n.imgSrc),b.$watch("aspectRatio",n.aspectRatio),b.$watchCollection("selected",n.selected),a.extend(b,{move:function(a){var c,d,e=b.dragEvent,g=b.resizeStartEvent,h=b.selected,i=f[0].clientHeight-h.height,m=f[0].clientWidth-h.width;e?(c=h.top-(e.clientY-a.clientY),d=h.left-(e.clientX-a.clientX),h.top=0>c?0:c>i?i:c,h.left=0>d?0:d>m?m:d,j.refreshAndRender(k,b.selected,l),b.dragEvent=a):g&&this.onResizeSelected(a)},onResizeSelected:function(c){var d,e,f,g,h=b.resizeStartEvent,i=h.clientY-c.clientY,j=h.clientX-c.clientX,k=b.resizeDirection,l=b.selected,m=function(){if(a.isDefined(b.aspectRatio)){var c=0>j?-1*j:j,d=0>i?-1*i:i;c>d?j=0>j&&i>-1||j>-1&&0>i?-1*i:i:i=0>j&&i>-1||j>-1&&0>i?-1*j:j}};switch(k){case"nw":m(),d=l.top-i,e=l.left-j,g=l.width+j,f=l.height+i;break;case"ne":m(),d=l.top-i,e=l.left,g=l.width-j,f=l.height+i;break;case"sw":m(),d=l.top,e=l.left-j,f=l.height-i,g=l.width+j;break;case"se":m(),d=l.top,e=l.left,g=l.width-j,f=l.height-i;break;case"tr":d=l.top-i,f=l.height+i,e=l.left,g=l.width;break;case"br":d=l.top,f=l.height-i,e=l.left,g=l.width;break;case"lc":d=l.top,f=l.height,e=l.left-j,g=l.width+j;break;case"rc":d=l.top,f=l.height,e=l.left,g=l.width-j}f=0>d?f+d:f,g=0>e?g+e:g,this.resizeSelected(d,e,g,f),b.resizeStartEvent=c},resizeSelected:function(c,d,e,g){var h=b.selected,i=f[0].clientHeight-h.top,j=f[0].clientWidth-h.left,k=j>=e?0>e?0:e:j,l=i>=g?0>g?0:g:i;if(a.isDefined(b.aspectRatio)){var m=parseInt(b.aspectRatio.split(":")[0])/parseInt(b.aspectRatio.split(":")[1]);if(isNaN(m))throw"Invalid aspect-ratio";var n=function(){var a=k/m;a>i?(h.height=i,h.width=i*m):(h.height=a,h.width=k),h.left=d>0?d<h.left+h.width?d:h.left:0},o=function(){var a=l*m;a>j?(h.width=j,h.height=j/m):(h.height=l,h.width=l*m),h.left=d>0?d<h.left+h.width?d:h.left:0};h.width==k?o():h.height==l?n():g-l>e-k?o():n()}else h.top=c>0?c<h.top+h.height?c:h.top:0,h.left=d>0?d<h.left+h.width?d:h.left:0,h.width=j>=e?0>e?0:e:j,h.height=i>=g?0>g?0:g:i},cancel:function(){b.dragEvent=null,b.resizeStartEvent=null},ngImageEditor:{toDataURL:function(c){var d={imageType:"image/png",img:k,imgSize:l};return"string"==typeof c?d.imageType=c:d=a.extend(d,c),j.toDataURL(b.selected,d)},refresh:function(){j.refreshAndRender(k,b.selected,l)}}}),d.on("mousemove",function(a){b.move(a),b.$apply()}),d.on("mouseup",function(){b.cancel()})}]}}]),b.directive("ngImageSelected",function(){return{require:"^ngImageEditor",selected:"=",template:"<div style=\"box-sizing:border-box;background:rgba(255, 255, 255, 0.1);border:2px dashed #eaeaea;cursor:all-scroll;position:absolute;\" ng-style=\"{width:selected.width + 'px' , height:selected.height + 'px',left:selected.left + 'px',top:selected.top + 'px'}\" ng-mousedown=\"dragEvent=$event;$event.preventDefault()\"><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'nw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;left: -4px;position: absolute; cursor: nw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'ne' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: -4px;position: absolute; cursor: ne-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'sw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;left: -4px;position: absolute; cursor: sw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'se' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: -4px;position: absolute; cursor: se-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'tr' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'br' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'lc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;left: -4px;position: absolute; cursor: col-resize;; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'rc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;right: -4px;position: absolute; cursor: col-resize;; \"></div></div>",replace:!0,link:function(b,c,d){a.extend(b,{onResizeBlock:function(a,b){a.preventDefault(),a.stopPropagation(),this.resizeStartEvent=a,this.resizeDirection=b}})}}}),"undefined"!=typeof module&&(module.exports="ngImageEditor")}(angular);