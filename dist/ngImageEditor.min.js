/*! ngImageEditor 0.1.6 | Copyright (c) 2015 sparrow.jang | MIT license */
!function(a){"use strict";var b=a.module("ngImageEditor",[]),c=function(a){this.canvas_=a,this.ctx_=a.getContext("2d")};a.extend(c.prototype,{refresh:function(){var a=this.canvas_,b=a.parentNode;a.width=b.clientWidth,a.height=b.clientHeight},converterToGray_:function(){for(var a=this.ctx_,b=this.canvas_,c=a.getImageData(0,0,b.width,b.height),d=c.data,e=d.length,f=0;e>f;f+=4){var g=(d[f],d[f+1],d[f+2],.34*d[f]+.5*d[f+1]+.16*d[f+2]);d[f]=g,d[f+1]=g,d[f+2]=g}a.putImageData(c,0,0)},drawImageBlock:function(a,b,c,d,e,f,g,h,i){var j=h/a.width,k=i/a.height,l=d/a.width*f,m=e/a.height*g,n=f*j,o=g*k;b.drawImage(c,l,m,n,o,d,e,h,i)},render:function(a,b,c){var d=this.ctx_,e=this.canvas_,f=e.width,g=e.height;c.width/f,c.height/g;d.drawImage(a,0,0,f,g),this.converterToGray_(),this.drawImageBlock(e,d,a,b.left,b.top,c.width,c.height,b.width,b.height)},refreshAndRender:function(a,b,c){this.refresh(),this.render(a,b,c)},toDataURL:function(a,b){var c=this.canvas_,d=document.createElement("canvas"),e=d.getContext("2d");return d.width=b.width,d.height=b.height,e.drawImage(c,b.left,b.top,b.width,b.height,0,0,b.width,b.height),d.toDataURL(a)}}),b.directive("ngImageEditor",["$q","$document",function(b,d){var e=function(c){var d=new Image,e=document.createElement("div"),f=b.defer(),g=a.element(document.body);return d.crossOrigin="Anonymous",e.style.cssText="width:0px;height:0px;overflow:hidden;",d.onload=function(){var a,b;a=d.width,b=d.height,e.parentNode.removeChild(e),f.resolve({width:a,height:b})},e.appendChild(d),d.src=a.isString(c)?c:c.src,g.append(e),f.promise};return{scope:{imgSrc:"=",ngImageEditor:"=?",onImgChange:"&",enabledResizeSelector:"=?",selected:"="},template:'<div ng-mouseup="cancel( $event )" unselectable="on"><img unselectable="on" style="opacity:0;user-drag: none;width:100%;height:100%;" crossorigin="Anonymous" ng-src="{{imgSrc}}" ng-mousedown="$event.preventDefault()" /><canvas width="100%" height="100%" style="position:absolute;top:0px;left:0px;"></canvas><div ng-image-selected></div></div>',controller:["$scope","$element","$attrs",function(b,f,g){var h,i,j,k,l,m;f.css({position:"relative","user-drag":"none"}).attr("unselectable","on"),i=f.find("canvas"),h=i[0],j=new c(h),k=f.find("img")[0],m=a.element(document.body);var n={imgSrc:function(a){var c=e(a);c.then(function(a){l=a,j.refreshAndRender(k,b.selected,l),b.onImgChange({imgSize:l})})},selected:function(a){null==b.dragEvent&&l&&j.refreshAndRender(k,a,l)}};b.$watch("imgSrc",n.imgSrc),b.$watchCollection("selected",n.selected),a.extend(b,{move:function(a){var c,d,e=b.dragEvent,g=b.resizeStartEvent,h=b.selected,i=f[0].clientHeight-h.height,m=f[0].clientWidth-h.width;e?(c=h.top-(e.clientY-a.clientY),d=h.left-(e.clientX-a.clientX),h.top=0>c?0:c>i?i:c,h.left=0>d?0:d>m?m:d,j.refreshAndRender(k,b.selected,l),b.dragEvent=a):g&&this.onResizeSelected(a)},onResizeSelected:function(a){var c,d,e,f,g=b.resizeStartEvent,h=g.clientY-a.clientY,i=g.clientX-a.clientX,j=b.resizeDirection,k=b.selected;switch(j){case"nw":c=k.top-h,d=k.left-i,f=k.width+i,e=k.height+h;break;case"ne":c=k.top-h,d=k.left,f=k.width-i,e=k.height+h;break;case"sw":c=k.top,d=k.left-i,e=k.height-h,f=k.width+i;break;case"se":c=k.top,d=k.left,f=k.width-i,e=k.height-h;break;case"tr":c=k.top-h,e=k.height+h,d=k.left,f=k.width;break;case"br":c=k.top,e=k.height-h,d=k.left,f=k.width;break;case"lc":c=k.top,e=k.height,d=k.left-i,f=k.width+i;break;case"rc":c=k.top,e=k.height,d=k.left,f=k.width-i}e=0>c?e+c:e,f=0>d?f+d:f,this.resizeSelected(c,d,f,e),b.resizeStartEvent=a},resizeSelected:function(a,c,d,e){var g=b.selected,h=f[0].clientHeight-g.top,i=f[0].clientWidth-g.left;g.top=a>0?a<g.top+g.height?a:g.top:0,g.left=c>0?c<g.left+g.width?c:g.left:0,g.width=i>=d?0>d?0:d:i,g.height=h>=e?0>e?0:e:h},cancel:function(){b.dragEvent=null,b.resizeStartEvent=null},ngImageEditor:{toDataURL:function(a){var c=a?a:"image/png";return j.toDataURL(c,b.selected)},refresh:function(){j.refreshAndRender(k,b.selected,l)}}}),d.on("mousemove",function(a){b.move(a),b.$apply()}),d.on("mouseup",function(){b.cancel()})}]}}]),b.directive("ngImageSelected",function(){return{require:"^ngImageEditor",selected:"=",template:"<div style=\"box-sizing:border-box;background:rgba(255, 255, 255, 0.1);border:2px dashed #eaeaea;cursor:all-scroll;position:absolute;\" ng-style=\"{width:selected.width + 'px' , height:selected.height + 'px',left:selected.left + 'px',top:selected.top + 'px'}\" ng-mousedown=\"dragEvent=$event;$event.preventDefault()\"><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'nw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;left: -4px;position: absolute; cursor: nw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'ne' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: -4px;position: absolute; cursor: ne-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'sw' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;left: -4px;position: absolute; cursor: sw-resize;\"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'se' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: -4px;position: absolute; cursor: se-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'tr' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);top: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'br' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: -4px;right: 49%;position: absolute; cursor: row-resize; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'lc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;left: -4px;position: absolute; cursor: col-resize;; \"></div><div ng-style=\"{display:enabledResizeSelector?'block':'none'}\" ng-mousedown=\"onResizeBlock( $event, 'rc' )\" style=\"width: 8px;height: 8px;background: rgba(151, 151, 151, 0.7);bottom: 49%;right: -4px;position: absolute; cursor: col-resize;; \"></div></div>",replace:!0,link:function(b,c,d){a.extend(b,{onResizeBlock:function(a,b){a.preventDefault(),a.stopPropagation(),this.resizeStartEvent=a,this.resizeDirection=b}})}}})}(angular);